# ROS2 V4L2 Camera - å¤šç›¸æœºç»„ä»¶ç³»ç»Ÿ

[![ROS2](https://img.shields.io/badge/ROS2-Humble-blue.svg)](https://docs.ros.org/en/humble/)
[![License](https://img.shields.io/badge/License-Apache%202.0-orange.svg)](LICENSE)

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ ROS2 å¤šç›¸æœºé©±åŠ¨ç³»ç»Ÿï¼ŒåŸºäº Video4Linux2 (V4L2)ï¼Œæ”¯æŒç»„ä»¶åŒ–æ¶æ„ã€è®¾å¤‡åˆ†ç»„ç®¡ç†å’Œè¿›ç¨‹å†…é€šä¿¡ä¼˜åŒ–ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½**: åŸºäº ROS2 ç»„ä»¶æ¶æ„ï¼Œæ”¯æŒè¿›ç¨‹å†…é›¶æ‹·è´é€šä¿¡
- ğŸ“¹ **å¤šç›¸æœºæ”¯æŒ**: åŒæ—¶ç®¡ç†å¤šä¸ªç›¸æœºè®¾å¤‡ï¼Œæ”¯æŒè®¾å¤‡åˆ†ç»„
- âš™ï¸ **çµæ´»é…ç½®**: YAML é…ç½®æ–‡ä»¶æ”¯æŒï¼Œæ˜“äºç®¡ç†ä¸åŒç›¸æœºç»„åˆ
- ğŸ–¼ï¸ **å¤šæ ¼å¼è¾“å‡º**: æ”¯æŒåŸå§‹ UYVY å’Œ RGB æ ¼å¼ï¼Œå¯é€‰å‹ç¼©ä¼ è¾“
- ğŸ“Š **å®æ—¶ç›‘æ§**: å†…ç½®é¢‘ç‡ç›‘æ§å’ŒçŠ¶æ€æŠ¥å‘Š
- ğŸ”§ **æ˜“äºæ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰ç›¸æœºç±»å‹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘é¡¹ç›®

```bash
cd /home/cyberbus/driver_ws
colcon build --packages-select v4l2_camera --cmake-args -DCMAKE_BUILD_TYPE=Release
source install/setup.bash
```

### 2. æ£€æŸ¥ç›¸æœºè®¾å¤‡

```bash
# æŸ¥çœ‹å¯ç”¨è®¾å¤‡
ls -la /dev/video*

# è®¾ç½®æƒé™ï¼ˆå¦‚éœ€è¦ï¼‰
sudo chmod 666 /dev/video*
```

### 3. å¯åŠ¨ç›¸æœºç³»ç»Ÿ

```bash
# å¯åŠ¨æ‰€æœ‰ç›¸æœºç»„
ros2 launch v4l2_camera multi_camera_all_groups.launch.py

# é€‰æ‹©æ€§å¯åŠ¨ç‰¹å®šç›¸æœºç»„
ros2 launch v4l2_camera multi_camera_select_group.launch.py enabled_groups:=fisheye

# å¯åŠ¨å¤šä¸ªç»„åˆ
ros2 launch v4l2_camera multi_camera_select_group.launch.py enabled_groups:=fisheye,front

# å¯åŠ¨å•ä¸ªç›¸æœºè¿›è¡Œæµ‹è¯•
ros2 launch v4l2_camera single_camera_launcher.launch.py
```

### 4. éªŒè¯è¿è¡ŒçŠ¶æ€

```bash
# æŸ¥çœ‹ç›¸æœºè¯é¢˜
ros2 topic list | grep image

# ç›‘æ§å›¾åƒé¢‘ç‡
ros2 topic hz /fisheye/image_raw

# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
ros2 topic echo /multi_camera_status
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
ros2_v4l2_camera/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ camera_groups_config.yaml    # ç›¸æœºç»„é…ç½®æ–‡ä»¶
â”œâ”€â”€ include/v4l2_camera/
â”‚   â”œâ”€â”€ camera_launcher_component.hpp # ç›¸æœºç»„ä»¶å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ multi_camera_component.hpp   # å¤šç›¸æœºç®¡ç†å™¨
â”‚   â””â”€â”€ visibility_control.h         # å¯è§æ€§æ§åˆ¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ camera_launcher_component.cpp # ç›¸æœºç»„ä»¶å®ç°
â”‚   â”œâ”€â”€ multi_camera_component.cpp   # å¤šç›¸æœºç®¡ç†å™¨å®ç°
â”‚   â”œâ”€â”€ simple_multi_camera_example.cpp # ä½¿ç”¨ç¤ºä¾‹
â”‚   â””â”€â”€ v4l2_camera_node.cpp         # åŸå§‹å•ç›¸æœºèŠ‚ç‚¹
â”œâ”€â”€ launch/
â”‚   â”œâ”€â”€ multi_camera_all_groups.launch.py    # å¯åŠ¨æ‰€æœ‰ç›¸æœºç»„
â”‚   â”œâ”€â”€ multi_camera_select_group.launch.py  # é€‰æ‹©æ€§å¯åŠ¨ç›¸æœºç»„
â”‚   â””â”€â”€ single_camera_launcher.launch.py     # å•ç›¸æœºæµ‹è¯•å¯åŠ¨
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ cleanup_cameras.sh          # è®¾å¤‡æ¸…ç†è„šæœ¬
â””â”€â”€ docs/                           # è¯¦ç»†æ–‡æ¡£
```

## âš™ï¸ é…ç½®æ–‡ä»¶

### camera_groups_config.yaml

```yaml
device_groups:
  fisheye:
    description: "é±¼çœ¼ç›¸æœºç»„"
    devices:
      - device_path: "/dev/video0"
        camera_id: "fisheye0"
        topic_prefix: "fisheye"
        width: 1920
        height: 1080
        publish_rate: 30
      - device_path: "/dev/video1"
        camera_id: "fisheye1"
        topic_prefix: "fisheye"
        width: 1920
        height: 1080
        publish_rate: 30
  
  surround:
    description: "ç¯è§†ç›¸æœºç³»ç»Ÿ"
    devices:
      - device_path: "/dev/video8"
        camera_id: "surround0"
        topic_prefix: "surround"
        width: 1920
        height: 1500
        publish_rate: 30
      # ... æ›´å¤šè®¾å¤‡é…ç½®
  
  front:
    description: "å‰è§†ç›¸æœºç»„"
    devices:
      - device_path: "/dev/video4"
        camera_id: "front0"
        topic_prefix: "front"
        width: 1920
        height: 1080
        publish_rate: 30
```

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### æ–¹å¼ 1: Launch æ–‡ä»¶ï¼ˆæ¨èï¼‰

```bash
# å¯åŠ¨æ‰€æœ‰ç›¸æœºç»„ï¼ˆé»˜è®¤é…ç½®ï¼‰
ros2 launch v4l2_camera multi_camera_all_groups.launch.py

# é€‰æ‹©æ€§å¯åŠ¨ç›¸æœºç»„
ros2 launch v4l2_camera multi_camera_select_group.launch.py \
  enabled_groups:=fisheye,surround

# è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
ros2 launch v4l2_camera multi_camera_select_group.launch.py \
  camera_config_file:=/path/to/custom_config.yaml \
  enabled_groups:=front
```

### æ–¹å¼ 2: å•ç›¸æœºæµ‹è¯•

```bash
ros2 launch v4l2_camera single_camera_launcher.launch.py \
  arg_camera_dev:=/dev/video0 \
  arg_camera_id:=test_camera \
  arg_publish_topic:=/test_camera
```

### æ–¹å¼ 3: ç»„ä»¶å®¹å™¨ï¼ˆé«˜çº§ç”¨æ³•ï¼‰

```bash
# å¯åŠ¨å®¹å™¨
ros2 run rclcpp_components component_container_mt --ros-args -r __node:=multi_camera_container

# åŠ è½½ç»„ä»¶
ros2 component load /multi_camera_container v4l2_camera v4l2_camera::MultiCameraComponent
```

## ğŸ“Š å‚æ•°é…ç½®

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enabled_groups` | string | fisheye,surround,front | è¦å¯åŠ¨çš„è®¾å¤‡ç»„åç§°ï¼ˆé€—å·åˆ†éš”ï¼‰ |
| `camera_config_file` | string | é»˜è®¤è·¯å¾„ | YAMLé…ç½®æ–‡ä»¶è·¯å¾„ |
| `use_image_transport` | bool | true | å¯ç”¨image_transportï¼ˆæ”¯æŒå‹ç¼©ï¼‰ |
| `convert_to_rgb` | bool | true | è½¬æ¢ä¸ºRGBæ ¼å¼ï¼ˆfalse=åŸå§‹UYVYï¼‰ |
| `jpeg_quality` | int | 40/60/30 | JPEGå‹ç¼©è´¨é‡ï¼ˆæŒ‰ç»„é…ç½®ï¼‰ |
| `use_intra_process_comms` | bool | true | å¯ç”¨è¿›ç¨‹å†…é€šä¿¡ä¼˜åŒ– |

## ğŸ–¼ï¸ å›¾åƒæ ¼å¼å’Œè¯é¢˜

### è¯é¢˜å‘½åè§„åˆ™
- é±¼çœ¼ç›¸æœº: `/fisheye/image_raw`, `/fisheye/camera_info`
- ç¯è§†ç›¸æœº: `/surround/image_raw`, `/surround/camera_info`
- å‰è§†ç›¸æœº: `/front/image_raw`, `/front/camera_info`

### åŸå§‹ UYVY æ ¼å¼ (convert_to_rgb=false)
- **ç¼–ç **: `yuv422_yuy2`
- **ä¼˜åŠ¿**: ä¿æŒç›¸æœºåŸå§‹æ ¼å¼ï¼ŒCPUè´Ÿè½½ä½ï¼Œä¼ è¾“æ•ˆç‡é«˜
- **å¤§å°**: width Ã— height Ã— 2 bytes

### RGB æ ¼å¼ (convert_to_rgb=true)
- **ç¼–ç **: `rgb8`  
- **ä¼˜åŠ¿**: ç›´æ¥å¯è§†åŒ–ï¼Œå¹¿æ³›å…¼å®¹
- **å¤§å°**: width Ã— height Ã— 3 bytes

### å‹ç¼©ä¼ è¾“ (use_image_transport=true)
å½“å¯ç”¨æ—¶ï¼Œæ¯ä¸ªç›¸æœºç»„ä¼šå‘å¸ƒï¼š
- `/fisheye/image_raw` - åŸå§‹å›¾åƒ
- `/fisheye/image_raw/compressed` - JPEGå‹ç¼©
- `/fisheye/image_raw/theora` - Theoraå‹ç¼©


## â±ï¸ ç¡¬ä»¶æ—¶é—´æˆ³æ”¯æŒ

### æ—¶é—´æˆ³ç‰¹æ€§

æœ¬é¡¹ç›®ä½¿ç”¨ V4L2 buffer æœºåˆ¶è·å–ç›¸æœºç¡¬ä»¶æ—¶é—´æˆ³ï¼Œæä¾›é«˜ç²¾åº¦çš„å›¾åƒé‡‡é›†æ—¶é—´ä¿¡æ¯ï¼š

- **ç¡¬ä»¶çº§ç²¾åº¦**: ç›´æ¥ä»ç›¸æœºé©±åŠ¨è·å–æ—¶é—´æˆ³ï¼Œé¿å…è½¯ä»¶å»¶è¿Ÿ
- **å¤šç›¸æœºåŒæ­¥**: æ”¯æŒå¤šç›¸æœºé—´çš„ç²¾ç¡®æ—¶é—´åŒæ­¥
- **ROS2 æ—¶é—´å…¼å®¹**: è‡ªåŠ¨è½¬æ¢ä¸º ROS2 æ—¶é—´æ ¼å¼
- **æ—¶é’Ÿæ ¡å‡†**: æ”¯æŒç³»ç»Ÿæ—¶é’Ÿåç§»æ ¡å‡†

### æ—¶é—´æˆ³éªŒè¯

#### æ£€æŸ¥ç›¸æœºè®¾å¤‡æ—¶é—´æˆ³æ”¯æŒ

```bash
# éªŒè¯è®¾å¤‡æ—¶é—´æˆ³åŠŸèƒ½
v4l2-ctl --stream-mmap --stream-count=3 -d /dev/video0 --verbose


#### éªŒè¯ROS2è¯é¢˜æ—¶é—´æˆ³

```bash
# æ£€æŸ¥å›¾åƒæ¶ˆæ¯çš„æ—¶é—´æˆ³å­—æ®µ
ros2 topic echo /fisheye/image_raw --field header.stamp

# ç›‘æ§æ—¶é—´æˆ³è¿ç»­æ€§
ros2 run rqt_plot rqt_plot /fisheye/image_raw/header/stamp/sec
```

#### å¤šç›¸æœºæ—¶é—´åŒæ­¥æ£€æŸ¥

```bash
# åŒæ—¶ç›‘æ§å¤šä¸ªç›¸æœºçš„æ—¶é—´æˆ³
ros2 topic echo /fisheye/image_raw --field header.stamp &
ros2 topic echo /surround/image_raw --field header.stamp &
ros2 topic echo /front/image_raw --field header.stamp &

# ä½¿ç”¨æ—¶é—´æˆ³åŒæ­¥å·¥å…·
ros2 run message_filters approximate_sync_example
```


#### æŸ¥çœ‹ç³»ç»Ÿæ—¶é’Ÿåç§»

```bash
# æ£€æŸ¥ç³»ç»Ÿæ—¶é’Ÿåç§»é‡
cat /sys/devices/system/clocksource/clocksource0/offset_ns

# æ‰‹åŠ¨è®¾ç½®åç§»é‡ï¼ˆå¦‚éœ€è¦ï¼‰
echo 1000000 | sudo tee /sys/devices/system/clocksource/clocksource0/offset_ns
```



## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### ç³»ç»ŸçŠ¶æ€ç›‘æ§

ç³»ç»Ÿè¿è¡Œæ—¶ä¼šæ˜¾ç¤ºè¯¦ç»†çŠ¶æ€ä¿¡æ¯ï¼š

```
=== Camera Status Update ===
Camera status: 4/4 cameras running
  Camera 0 (/dev/video0): RUNNING -> /fisheye
  Camera 1 (/dev/video1): RUNNING -> /fisheye
  Camera 2 (/dev/video8): RUNNING -> /surround
  Camera 3 (/dev/video9): RUNNING -> /surround

=== Camera Frequency Statistics ===
  /fisheye/image_raw: 30.0 Hz (target: 30.0 Hz) [NORMAL]
  /surround/image_raw: 29.8 Hz (target: 30.0 Hz) [NORMAL]
Active cameras: 4/4 | Total frequency: 119.8 Hz | Efficiency: 99.8%
```

### å¸¸ç”¨è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹ç»„ä»¶çŠ¶æ€
ros2 component list

# ç›‘æ§è¯é¢˜
ros2 topic list | grep camera
ros2 topic hz /fisheye/image_raw

# æŸ¥çœ‹å›¾åƒä¿¡æ¯
ros2 topic echo /fisheye/image_raw --once | head -20

# æ£€æŸ¥è®¾å¤‡
v4l2-ctl --list-devices
lsof /dev/video*
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### è®¾å¤‡å¿™é”™è¯¯
```bash
# è¿è¡Œæ¸…ç†è„šæœ¬
./scripts/cleanup_cameras.sh

# æ‰‹åŠ¨æ£€æŸ¥å ç”¨
lsof /dev/video*

# é‡å¯ç›¸æœºæ¨¡å—
sudo modprobe -r uvcvideo
sudo modprobe uvcvideo
```

### æƒé™é—®é¢˜
```bash
# è®¾ç½®è®¾å¤‡æƒé™
sudo chmod 666 /dev/video*

# æ·»åŠ ç”¨æˆ·åˆ°videoç»„
sudo usermod -a -G video $USER
```

### æ²¡æœ‰å›¾åƒè¾“å‡º
```bash
# éªŒè¯è®¾å¤‡åŠŸèƒ½
v4l2-ctl -d /dev/video0 --list-formats-ext

# æ£€æŸ¥è¯é¢˜æ•°æ®
ros2 topic echo /fisheye/image_raw --field header
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### æ¨èé…ç½®
- **é«˜æ€§èƒ½**: `convert_to_rgb=false` + `use_image_transport=true`
- **å¯è§†åŒ–**: `convert_to_rgb=true` + `use_image_transport=true`  
- **ä½å»¶è¿Ÿ**: `convert_to_rgb=false` + `use_image_transport=false`

### ä¸åŒç›¸æœºç»„çš„è´¨é‡è®¾ç½®
- **é±¼çœ¼ç›¸æœº**: `jpeg_quality=40` (å¹³è¡¡è´¨é‡å’Œæ€§èƒ½)
- **å‰è§†ç›¸æœº**: `jpeg_quality=60` (é«˜è´¨é‡ï¼Œç”¨äºæ£€æµ‹)
- **ç¯è§†ç›¸æœº**: `jpeg_quality=30` (ä½è´¨é‡ï¼Œç”¨äºç›‘æ§)

### æ€§èƒ½ç‰¹ç‚¹
- âœ… è¿›ç¨‹å†…é›¶æ‹·è´é€šä¿¡
- âœ… ç»„ä»¶åŒ–æ¶æ„æé«˜æ•ˆç‡
- âœ… å¯é€‰æ‹©æ€§å¯åŠ¨å‡å°‘èµ„æºå ç”¨
- âœ… å¤šçº¿ç¨‹æ‰§è¡Œå™¨æé«˜å¹¶å‘æ€§èƒ½

## ğŸ”§ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°ç›¸æœºç»„
1. ç¼–è¾‘ `config/camera_groups_config.yaml`
2. åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æ–°çš„è®¾å¤‡ç»„
3. åœ¨å¯åŠ¨æ–‡ä»¶ä¸­æ·»åŠ å¯¹åº”çš„ComposableNode
4. é‡å¯ç³»ç»Ÿ

### è‡ªå®šä¹‰ç›¸æœºç»„ä»¶
1. ç»§æ‰¿ `CameraLauncherComponent`
2. é‡å†™ `configure()` å’Œ `start()` æ–¹æ³•
3. æ³¨å†Œåˆ° CMakeLists.txt

## ğŸ“š æ–‡æ¡£

- [è¯¦ç»†ä½¿ç”¨æŒ‡å—](USAGE_GUIDE.md) - å®Œæ•´çš„ä½¿ç”¨è¯´æ˜
- [å¿«é€Ÿå¯åŠ¨æŒ‡å—](QUICK_START_GUIDE.md) - å¿«é€Ÿä¸Šæ‰‹
- [å¤šç›¸æœºä½¿ç”¨æ–‡æ¡£](MULTI_CAMERA_USAGE.md) - å¤šç›¸æœºé…ç½®è¯¦è§£
- [åŸå§‹å›¾åƒè¾“å‡ºè¯´æ˜](README_RAW_IMAGE.md) - å›¾åƒæ ¼å¼è¯´æ˜
- [å®ç°æ€»ç»“](IMPLEMENTATION_SUMMARY.md) - æŠ€æœ¯å®ç°è¯¦æƒ…

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- **ROS2**: Humble æˆ–æ›´é«˜ç‰ˆæœ¬
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04/22.04 LTS
- **ä¾èµ–åŒ…**: 
  - `rclcpp`
  - `rclcpp_components`
  - `sensor_msgs`
  - `image_transport`
  - `opencv`
  - `yaml-cpp`

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache 2.0 è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## ğŸ“ æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ•…éšœæ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥æ—¥å¿—è¾“å‡º
3. æä¾›å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å’Œç¯å¢ƒé…ç½®
4. åˆ›å»º GitHub Issue

---

**å¿«é€Ÿå¼€å§‹å‘½ä»¤**:
```bash
# ä¸€é”®å¯åŠ¨æ‰€æœ‰ç›¸æœºç»„
cd /home/cyberbus/driver_ws && source install/setup.bash
ros2 launch v4l2_camera multi_camera_all_groups.launch.py

# é€‰æ‹©æ€§å¯åŠ¨ç‰¹å®šç»„
ros2 launch v4l2_camera multi_camera_select_group.launch.py enabled_groups:=fisheye,front
```
